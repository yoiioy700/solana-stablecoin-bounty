name: CI/CD - SSS Token

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  SOLANA_VERSION: 1.17.0
  ANCHOR_VERSION: 0.30.1

jobs:
  # ============================================
  # RUST CHECKS
  # ============================================
  rust-check:
    name: Rust Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Check Formatting
        run: |
          cd programs/sss-token
          cargo fmt -- --check
          cd ../sss-transfer-hook
          cargo fmt -- --check

      - name: Run Clippy
        run: |
          cd programs/sss-token
          cargo clippy -- -D warnings
          cd ../sss-transfer-hook
          cargo clippy -- -D warnings

  # ============================================
  # BUILD ANCHOR PROGRAMS
  # ============================================
  build-programs:
    name: Build Anchor Programs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      - name: Install Anchor
        run: |
          npm install -g @coral-xyz/anchor-cli@${ANCHOR_VERSION}
          anchor --version

      - name: Cache Build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-anchor-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Programs
        run: |
          anchor build

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: anchor-programs
          path: target/deploy/*.so

  # ============================================
  # TEST ANCHOR PROGRAMS
  # ============================================
  test-programs:
    name: Test Anchor Programs
    runs-on: ubuntu-latest
    needs: [build-programs]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana config set --url localhost

      - name: Install Anchor
        run: |
          npm install -g @coral-xyz/anchor-cli@${ANCHOR_VERSION}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm install
          cd sdk && npm install
          cd ../cli && npm install
          cd ../backend && npm install

      - name: Start Local Validator
        run: |
          solana-test-validator --quiet --reset &
          sleep 10

      - name: Run Tests
        run: |
          anchor test --skip-build

      - name: Coverage Report
        run: |
          npm run coverage || true

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  # ============================================
  # SDK TESTS
  # ============================================
  test-sdk:
    name: Test SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install SDK Dependencies
        run: |
          cd sdk
          npm install

      - name: Build SDK
        run: |
          cd sdk
          npm run build

      - name: Test SDK
        run: |
          cd sdk
          npm test

      - name: Lint SDK
        run: |
          cd sdk
          npm run lint

  # ============================================
  # BACKEND TESTS
  # ============================================
  test-backend:
    name: Test Backend Services
    runs-on: ubuntu-latest
    needs: [test-programs]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: sss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Backend Dependencies
        run: |
          cd backend
          npm install

      - name: Setup Database
        run: |
          cd backend
          npm run db:migrate
          npm run db:seed

      - name: Test Backend
        run: |
          cd backend
          npm test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/sss_test
          REDIS_URL: redis://localhost:6379

  # ============================================
  # CLI TESTS
  # ============================================
  test-cli:
    name: Test CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install CLI Dependencies
        run: |
          cd cli
          npm install

      - name: Build CLI
        run: |
          cd cli
          npm run build

      - name: Test CLI
        run: |
          cd cli
          npm test

  # ============================================
  # DEPLOY TO DEVNET (Manual Trigger)
  # ============================================
  deploy-devnet:
    name: Deploy to Devnet
    runs-on: ubuntu-latest
    needs: [build-programs, test-programs]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: devnet
      url: https://explorer.solana.com/address/${{ vars.DEVNET_PROGRAM_ID }}?cluster=devnet

    steps:
      - uses: actions/checkout@v4

      - name: Setup Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"

      - name: Configure Solana
        run: |
          echo "${{ secrets.DEVNET_KEYPAIR }}" > /tmp/devnet-keypair.json
          solana config set --keypair /tmp/devnet-keypair.json
          solana config set --url devnet
          solana balance

      - name: Install Anchor
        run: |
          npm install -g @coral-xyz/anchor-cli@${ANCHOR_VERSION}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: anchor-programs

      - name: Deploy to Devnet
        run: |
          anchor deploy --provider.cluster devnet --program-name sss_token --program-keypair /tmp/devnet-keypair.json
          anchor deploy --provider.cluster devnet --program-name sss_transfer_hook

      - name: Update Devnet Config
        run: |
          SSS_TOKEN_ID=$(solana address -k /tmp/devnet-keypair.json)
          echo "{\"programs\": {\"sss_token\": {\"program_id\": \"$SSS_TOKEN_ID\", \"network\": \"devnet\"}}}" > deployments/devnet.json

      - name: Commit Deployment Info
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: update devnet deployment [skip ci]'
          file_pattern: 'deployments/devnet.json'
          branch: main

  # ============================================
  # SECURITY SCAN
  # ============================================
  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Cargo Audit
        uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run NPM Audit
        run: |
          npm audit --audit-level high

  # ============================================
  # SIZE CHECK
  # ============================================
  size-check:
    name: Check Binary Sizes
    runs-on: ubuntu-latest
    needs: [build-programs]
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v3
        with:
          name: anchor-programs

      - name: Check Sizes
        run: |
          for file in *.so; do
            size=$(stat -c%s "$file")
            echo "$file: $size bytes"
            if [ $size -gt 2097152 ]; then # 2MB limit
              echo "::error::File $file exceeds 2MB limit"
              exit 1
            fi
          done

  # ============================================
  # DEPENDENCY CHECK
  # ============================================
  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Rust Dependencies
        run: |
          cargo outdated --exit-code 1 || true

      - name: Check Node Dependencies
        run: |
          npm outdated || true
          cd sdk && npm outdated || true
